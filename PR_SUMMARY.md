# splitOn Support Foundation - PR Summary

## Overview
This PR establishes the foundation for adding splitOn functionality to DapperAOT, enabling support for multi-type mapping queries like `Query<Product, Category, Product>()`.

## What Changed

### 1. Analyzer Updates
- **Added `MultiType` operation flag** (`src/Dapper.AOT.Analyzers/Internal/Inspection.cs`)
  - New flag to identify multi-type Query methods (arity > 1)
  - Replaces `NotAotSupported` flag for these methods

- **Parameter Recognition** (`src/Dapper.AOT.Analyzers/CodeAnalysis/DapperAnalyzer.cs`)
  - Added "map" parameter (the mapping function)
  - Added "splitOn" parameter (column split point)
  - These parameters are now recognized and don't trigger "unexpected parameter" errors

- **Graceful Fallback** (`src/Dapper.AOT.Analyzers/CodeAnalysis/DapperInterceptorGenerator.cs`)
  - Multi-type queries temporarily marked with `DoNotGenerate` flag
  - Falls back to vanilla Dapper implementation
  - Includes detailed TODO comment with implementation roadmap reference

### 2. Test Updates
- **Updated DAP001 test** (`test/Dapper.AOT.Test/Verifiers/DAP001.cs`)
  - No longer expects "unsupported method" error for multi-type queries
  - Test now passes with empty diagnostic list

- **All Tests Passing**
  - 45 interceptor tests ✅
  - 149 verifier tests ✅
  - 0 security alerts ✅

### 3. Documentation
- **Implementation Guide** (`SPLITON_IMPLEMENTATION_GUIDE.md`)
  - Comprehensive architecture document
  - Detailed code examples for all components
  - Phased implementation plan (Phases 2-5)
  - Testing strategy and edge cases
  - Performance considerations

## Before This PR
```csharp
// This would generate DAP001 error: "Unsupported method"
var results = connection.Query<Product, Category, Product>(
    "SELECT * FROM Products p JOIN Categories c ON p.CategoryId = c.Id",
    (product, category) => { 
        product.Category = category; 
        return product; 
    },
    splitOn: "Id");
```

## After This PR
```csharp
// This now works! Falls back to vanilla Dapper (no error)
var results = connection.Query<Product, Category, Product>(
    "SELECT * FROM Products p JOIN Categories c ON p.CategoryId = c.Id",
    (product, category) => { 
        product.Category = category; 
        return product; 
    },
    splitOn: "Id");
```

## What's Next?

### Phase 2: Two-Type Support (Next Sprint)
1. Implement `MultiTypeRowFactory<T1, T2, TReturn>` runtime class
2. Update code generator to emit multi-type interceptors
3. Add comprehensive tests

### Phase 3-5: Complete Implementation
- Support for 3-7 type arities
- Async variants (`QueryAsync<T1, T2, TReturn>`)
- Single-row methods (`QueryFirst`, `QuerySingle` with multi-type)
- Buffered/unbuffered modes
- Performance optimization
- User documentation

See `SPLITON_IMPLEMENTATION_GUIDE.md` for full details.

## Technical Details

### Files Modified
- `src/Dapper.AOT.Analyzers/Internal/Inspection.cs` - Added MultiType flag
- `src/Dapper.AOT.Analyzers/CodeAnalysis/DapperAnalyzer.cs` - Added parameter recognition
- `src/Dapper.AOT.Analyzers/CodeAnalysis/DapperInterceptorGenerator.cs` - Added DoNotGenerate check
- `test/Dapper.AOT.Test/Verifiers/DAP001.cs` - Updated test expectations

### Files Created
- `SPLITON_IMPLEMENTATION_GUIDE.md` - Comprehensive implementation roadmap

### Test Results
```
✅ Interceptor Tests: 45/45 passed
✅ Verifier Tests: 149/149 passed
✅ CodeQL Scan: 0 alerts
✅ Code Review: All feedback addressed
```

### Path Separator Note
Some test output files show path separator changes (`\` → `/`). This is a benign artifact from running tests on Linux vs Windows and is auto-generated by the test framework.

## Impact

### For Users
- ✅ No more errors when using multi-type Query methods
- ✅ Code continues to work (using vanilla Dapper)
- ✅ Smooth upgrade path to AOT implementation when complete

### For Developers  
- ✅ Clear implementation roadmap
- ✅ Foundation in place for next phases
- ✅ All existing functionality preserved
- ✅ No breaking changes

## Security
- ✅ CodeQL analysis clean (0 alerts)
- ✅ No unsafe code introduced
- ✅ Graceful error handling for edge cases

## Compatibility
- ✅ Backward compatible
- ✅ Works with existing Dapper code
- ✅ No API changes
- ✅ Supports .NET Framework 4.8, .NET 8, .NET 9

## Questions?
Refer to `SPLITON_IMPLEMENTATION_GUIDE.md` for:
- Detailed architecture decisions
- Code generation examples
- Testing strategies
- Performance considerations
- Edge case handling
